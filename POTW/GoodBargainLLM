import 'dart:convert';
import 'package:dio/dio.dart';

class AIChatService {
  final _dio = Dio();

  Stream<Map<String, String>> streamResponse(String prompt) async* {
    final response = await _dio.post(
      "https://api.z.ai/api/paas/v4/chat/completions", // GLM-4.7 ì—”ë“œí¬ì¸íŠ¸ ì˜ˆì‹œ
      options: Options(headers: {"Authorization": "Bearer YOUR_KEY"}, responseType: ResponseType.stream),
      data: {
        "model": "glm-4.7",
        "messages": [{"role": "user", "content": prompt}],
        "stream": true
      },
    );

    String thinking = "";
    String content = "";

    await for (final chunk in response.data.stream) {
      final String decoded = utf8.decode(chunk);
      // SSE(Server-Sent Events) ë°ì´í„° íŒŒì‹±
      final lines = decoded.split('\n');
      for (final line in lines) {
        if (line.startsWith('data: ')) {
          final data = line.substring(6);
          if (data == '[DONE]') break;
          final json = jsonDecode(data);
          final delta = json['choices'][0]['delta'];

          // 2026ë…„ ëª¨ë¸ í•µì‹¬: ì¶”ë¡  ë‚´ìš©ê³¼ ì‹¤ì œ ë‹µë³€ êµ¬ë¶„
          if (delta['reasoning_content'] != null) {
            thinking += delta['reasoning_content'];
          }
          if (delta['content'] != null) {
            content += delta['content'];
          }
          yield {"thinking": thinking, "content": content};
        }
      }
    }
  }
}

class ChatBubble extends StatelessWidget {
  final String thinking;
  final String content;

  const ChatBubble({super.key, required this.thinking, required this.content});

  @override
  Widget build(BuildContext context) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        if (thinking.isNotEmpty)
          Container(
            padding: const EdgeInsets.all(12),
            decoration: BoxDecoration(
              color: Colors.grey[100],
              borderRadius: BorderRadius.circular(8),
              border: Border.all(color: Colors.blueAccent.withOpacity(0.3)),
            ),
            child: Text("ğŸ¤” ìƒê° ì¤‘: $thinking", style: TextStyle(fontSize: 12, color: Colors.grey[600])),
          ),
        const SizedBox(height: 10),
        if (content.isNotEmpty)
          MarkdownBody(data: content), // ê°€ì„±ë¹„ ëª¨ë¸ì˜ ë§ˆí¬ë‹¤ìš´ ì‘ë‹µì„ ì•„ë¦„ë‹µê²Œ í‘œì‹œ
      ],
    );
  }
}
